学习笔记

## Java字节码
Java字节码是JVM使用的指令集。

#### 字节码分类：
- 栈操作指令，包括与局部变量交互的指令；
 - 程序流程控制指令；
  - 对象操作指令，包括方法调用指令；
   - 算术运算以及类型转换指令。
  
`javap`是 JDK 内置的一款工具，专门用于反编译 class 文件，获取 class 文件中的指令清单。
用法示例：`javap -c -verbose xxx类`

#### 线程栈
JVM是一台基于栈的计算工具，每个线程都有一个独属于自己的线程栈(JVM Stack)用于存储`栈帧(Frame)`。栈帧由`操作数栈`、`局部变量区`和一个`class引用`（指向当前方法在运行时常量池中对应的class）组成。

##### 操作数栈
解释执行过程中，为Java方法分配栈桢时，JVM需要开辟一块额外的空间作为操作数栈，来存放计算的操作数及返回结果。

直接作用于操作数栈的指令：
- dup指令：复制栈顶元素，常用于复制new指令创建的未经初始化的引用；
 - pop指令：常用于舍弃调用指令返回的结果；
  -（dup和pop只能作用于非long、非double类型，因long、double占据两个栈单元）
   - swap指令：交换栈顶两个元素的值。

##### 局部变量区
是Java方法栈桢另一个重要的组成部分，字节码程序可以将计算的结果缓存在这里。
JVM将局部变量区当成一个数组，依次存放：this指针（仅非静态方法）、所传入的参数、以及字节码中局部变量。

#### 方法调用指令
1. invokestatic: 	用于调用静态方法
2. invokespecial:	用于调用私有实例方法、构造器；使用super关键字调用父类实例方法、构造器；所有实现接口的默认方法；
3. invokevirtual:		用于调用非私有实例方法
4. invokeinterface:	用于调用接口方法
5. invokedynamic:	用于调用动态方法

## 类加载器

#### 类的生命周期和加载过程
生命周期：`加载Loading`、`校验Verification`、`准备Preparation`、`解析Resolution`、`初始化initialization`、`使用Using`、`卸载Unloading`，前 5 个步骤是加载过程。

`加载Loading`
- 是指查找字节流，创建类的过程
 - Java分为基本类型和引用类型，其中，引用类型又分为：类、接口、数组类。基本类型由JVM事先定义好，数组类由JVM生成，另外两种则有对应的字节流。
  - 字节流常见形式为class文件，若找不到class文件，则报错`NoClassDefFoundError`

`校验Verification`
- 保证被加载的类能够满足JVM的约束条件

`准备Preparation`
- 为被加载类的静态字段分配内存（和构造方法表）

`解析Resolution`
- 将`符号引用`解析为实际引用
 - 符号引用，用来指代所要调用的方法，包含目标方法所在类的名字、目标方法的名字、接收参数类型以及返回值类型

`初始化initialization`
- JVM规范明确规定，必须在类的首次“主动使用”时才执行类的初始化
 - 初始化的过程执行：类的构造器、static静态变量赋值语句、static静态代码块
 
##### 类的初始化触发条件
1. JVM启动时初始化用户指定的主类
2. 遇到新建目标类的`new`指令时，初始化new指令的目标类
3. 遇到调用静态方法的指令，初始化该静态方法所在的类；
4. 遇到调用静态字段的指令，初始化该静态字段所在的类；
5. 子类的初始化会触发父类的初始化；
6. 一个定义了`default`方法的接口，初始化直接实现或间接实现该接口的类时，也会触发该接口的初始化；
7. 使用反射API对某个类进行反射调用时，初始化该类；
8. 初次调用MethodHandle实例时，初始化该MethodHandle指向的方法所在的类。

##### 不触发类初始化的情况
1. 通过子类引用父类静态字段，只会初始化父类，而不初始化子类；
2. 定义对象数组，不会触发该对象初始化(private Student student[]);
3. 常量在编译期间会存入调用类的常量池，本质上没有直接引用定义常量的类，不触发定义常量所在的类；
4. 通过类名获取Class对象；
5. 通过Class.forName加载指定类，若指定参数initialize为false时；
6. 通过ClassLoader默认的loadClass方法

 